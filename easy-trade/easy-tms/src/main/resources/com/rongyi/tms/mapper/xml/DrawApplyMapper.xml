<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="com.rongyi.tms.mapper.xml.DrawApplyMapper">
	<resultMap id="BaseResultMap" type="com.rongyi.easy.tms.entity.DrawApply">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="create_at" property="createAt" jdbcType="TIMESTAMP" />
		<result column="end_at" property="endAt" jdbcType="TIME" />
		<result column="mall_id" property="mallId" jdbcType="VARCHAR" />
		<result column="mall_name" property="mallName" jdbcType="VARCHAR" />
		<result column="shop_id" property="shopId" jdbcType="VARCHAR" />
		<result column="shop_name" property="shopName" jdbcType="VARCHAR" />
		<result column="seller_account" property="sellerAccount"
			jdbcType="VARCHAR" />
		<result column="seller_name" property="sellerName" jdbcType="VARCHAR" />
		<result column="draw_amount" property="drawAmount" jdbcType="DOUBLE" />
		<result column="pay_type" property="payType" jdbcType="INTEGER" />
		<result column="pay_account" property="payAccount" jdbcType="VARCHAR" />
		<result column="pay_name" property="payName" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="draw_no" property="drawNo" jdbcType="VARCHAR" />
		<result column="trade_no" property="tradeNo" jdbcType="VARCHAR" />
		<result column="trade_at" property="tradeAt" jdbcType="TIMESTAMP" />
		<result column="draw_user_id" property="drawUserId" jdbcType="VARCHAR" />
		<result column="draw_username" property="drawUsername" jdbcType="VARCHAR" />
		<result column="guide_type" property="guideType" jdbcType="INTEGER" />
	</resultMap>
	<resultMap id="DrawApplyInfo" type="com.rongyi.tms.moudle.vo.DrawApplyInfoVO">
		<id property="userId" column="draw_user_id" />
		<result property="drawForAuditTotal" column="draw_total" />
		<result property="drawForAuditToday" column="draw_today" />
	</resultMap>
	<sql id="Base_Column_List">
		id, create_at, end_at, mall_id, mall_name, shop_id, shop_name,
		seller_account, seller_name,
		draw_amount, pay_type, pay_account, pay_name, `status`,draw_no,trade_no,trade_at,draw_user_id,draw_username,guide_type
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from draw_apply
		where id = #{id,jdbcType=INTEGER}
	</select>
	<select id="selectByDrawNo" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select
		<include refid="Base_Column_List" />
		from draw_apply
		where draw_no = #{drawNo,jdbcType=VARCHAR}
	</select>
	<select id="selectByPage" resultMap="BaseResultMap"
		parameterType="java.util.Map">
		select
		<include refid="Base_Column_List" />
		from draw_apply
		where status in
		<foreach collection="status" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
		<if test="drawNO != null">
			and draw_no=#{drawNO,jdbcType=INTEGER}
		</if>
		<if test="mall != null">
			and mall_name=#{mall,jdbcType=VARCHAR}
		</if>
		<if test="shop != null">
			and shop_name=#{shop,jdbcType=VARCHAR}
		</if>
		<if test="sellerName != null">
			and seller_name like #{sellerName,jdbcType=VARCHAR}
		</if>
		<if test="sellerAccount != null">
			and seller_account like #{sellerAccount,jdbcType=VARCHAR}
		</if>
		<if test="id != null">
			and id=#{id,jdbcType=INTEGER}
		</if>
		<if test="tradeStart != null">
			and trade_at >= #{tradeStart,jdbcType=TIMESTAMP}
		</if>
		<if test="tradeEnd != null">
			and trade_at &lt;= #{tradeEnd,jdbcType=TIMESTAMP}
		</if>
		<if test="start != null">
			and create_at >= #{start,jdbcType=TIMESTAMP}
		</if>
		<if test="end != null">
			and create_at &lt;= #{end,jdbcType=TIMESTAMP}
		</if>
		<if test="amountStart != null">
			and draw_amount >= #{amountStart,jdbcType=INTEGER}
		</if>
		<if test="amountEnd != null and amountEnd !=0">
			and draw_amount &lt;= #{amountEnd,jdbcType=DOUBLE}
		</if>
		<if test="channel != null">
			and pay_type = #{channel,jdbcType=INTEGER}
		</if>
		<if test="tradeNo != null and channel !=0">
			and trade_no = #{tradeNo,jdbcType=INTEGER}
		</if>

		order by ${orderBy}

		limit #{begin,jdbcType=INTEGER},#{size,jdbcType=INTEGER}
	</select>
	<select id="countAll" resultType="int" parameterType="java.util.Map">
		select
		count(1)
		from draw_apply
		where status in
		<foreach collection="status" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
		<if test="drawNO != null">
			and draw_no=#{drawNO,jdbcType=INTEGER}
		</if>
		<if test="mall != null">
			and mall_name=#{mall,jdbcType=VARCHAR}
		</if>
		<if test="shop != null">
			and shop_name=#{shop,jdbcType=VARCHAR}
		</if>
		<if test="sellerName != null">
			and seller_name like #{sellerName,jdbcType=VARCHAR}
		</if>
		<if test="sellerAccount != null">
			and seller_account like #{sellerAccount,jdbcType=VARCHAR}
		</if>
		<if test="id != null">
			and id=#{id,jdbcType=INTEGER}
		</if>
		<if test="start != null">
			and create_at >= #{start,jdbcType=TIMESTAMP}
		</if>
		<if test="end != null">
			and create_at &lt;= #{end,jdbcType=TIMESTAMP}
		</if>
		<if test="amountStart != null">
			and draw_amount >= #{amountStart,jdbcType=INTEGER}
		</if>
		<if test="amountEnd != null and amountEnd !=0">
			and draw_amount &lt;= #{amountEnd,jdbcType=DOUBLE}
		</if>
		<if test="channel != null and channel !=0">
			and pay_type = #{channel,jdbcType=INTEGER}
		</if>
		<if test="tradeNo != null and channel !=0">
			and trade_no = #{tradeNo,jdbcType=INTEGER}
		</if>
		<if test="tradeStart != null">
			and trade_at >= #{tradeStart,jdbcType=TIMESTAMP}
		</if>
		<if test="tradeEnd != null">
			and trade_at &lt;= #{tradeEnd,jdbcType=TIMESTAMP}
		</if>
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		delete from draw_apply
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.rongyi.easy.tms.entity.DrawApply"
		useGeneratedKeys="true" keyProperty="id">
		insert into draw_apply (create_at, end_at, mall_id,
		mall_name, shop_id, shop_name,
		seller_account, seller_name, draw_amount,
		pay_type, pay_account, pay_name,
		`status`,draw_no,draw_user_id,draw_username,guide_type)
		values (#{createAt,jdbcType=TIMESTAMP}, #{endAt,jdbcType=TIME},
		#{mallId,jdbcType=VARCHAR},
		#{mallName,jdbcType=VARCHAR}, #{shopId,jdbcType=INTEGER}, #{shopName,jdbcType=VARCHAR},
		#{sellerAccount,jdbcType=VARCHAR}, #{sellerName,jdbcType=VARCHAR},
		#{drawAmount,jdbcType=INTEGER},
		#{payType,jdbcType=INTEGER}, #{payAccount,jdbcType=VARCHAR}, #{payName,jdbcType=VARCHAR},
		#{status,jdbcType=INTEGER},	#{drawNo,jdbcType=VARCHAR},#{drawUserId,jdbcType=VARCHAR},#{drawUsername,jdbcType=VARCHAR},
		#{guideType,jdbcType=INTEGER})
	</insert>
	<insert id="insertSelective" parameterType="com.rongyi.easy.tms.entity.DrawApply"
		useGeneratedKeys="true" keyProperty="id">
		insert into draw_apply
		<trim prefix="(" suffix=")" suffixOverrides=",">
			create_at,
			end_at,
			mall_id,
			mall_name,
			shop_id,
			shop_name,
			seller_account,
			seller_name,
			draw_amount,
			pay_type,
			pay_account,
			pay_name,
			`status`,
			draw_no,
			guide_type
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			#{createAt,jdbcType=TIMESTAMP},
			#{endAt,jdbcType=TIME},
			#{mallId,jdbcType=VARCHAR},
			#{mallName,jdbcType=VARCHAR},
			#{shopId,jdbcType=INTEGER},
			#{shopName,jdbcType=VARCHAR},
			#{sellerAccount,jdbcType=VARCHAR},
			#{sellerName,jdbcType=VARCHAR},
			#{drawAmount,jdbcType=INTEGER},
			#{payType,jdbcType=INTEGER},
			#{payAccount,jdbcType=VARCHAR},
			#{payName,jdbcType=VARCHAR},
			#{status,jdbcType=INTEGER},
			#{drawNo,jdbcType=VARCHAR},
			#{guideType,jdbcType=INTEGER}
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.rongyi.easy.tms.entity.DrawApply">
		update draw_apply
		<set>
			<if test="createAt != null">
				create_at = #{createAt,jdbcType=TIMESTAMP},
			</if>
			<if test="endAt != null">
				end_at = #{endAt,jdbcType=TIME},
			</if>
			<if test="mallId != null">
				mall_id = #{mallId,jdbcType=VARCHAR},
			</if>
			<if test="mallName != null">
				mall_name = #{mallName,jdbcType=VARCHAR},
			</if>
			<if test="shopId != null">
				shop_id = #{shopId,jdbcType=INTEGER},
			</if>
			<if test="shopName != null">
				shop_name = #{shopName,jdbcType=VARCHAR},
			</if>
			<if test="sellerAccount != null">
				seller_account = #{sellerAccount,jdbcType=VARCHAR},
			</if>
			<if test="sellerName != null">
				seller_name = #{sellerName,jdbcType=VARCHAR},
			</if>
			<if test="drawAmount != null">
				draw_amount = #{drawAmount,jdbcType=DOUBLE},
			</if>
			<if test="payType != null">
				pay_type = #{payType,jdbcType=INTEGER},
			</if>
			<if test="payAccount != null">
				pay_account = #{payAccount,jdbcType=VARCHAR},
			</if>
			<if test="payName != null">
				pay_name = #{payName,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				`status` = #{status,jdbcType=INTEGER},
			</if>
			<if test="drawNo != null">
				draw_no = #{drawNo,jdbcType=VARCHAR}
			</if>
			<if test="guideType != null">
				guide_type = #{guideType,jdbcType=INTEGER}
			</if>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.rongyi.easy.tms.entity.DrawApply">
		update draw_apply
		set create_at = #{createAt,jdbcType=TIMESTAMP},
		end_at = #{endAt,jdbcType=TIME},
		mall_id = #{mallId,jdbcType=VARCHAR},
		mall_name = #{mallName,jdbcType=VARCHAR},
		shop_id = #{shopId,jdbcType=INTEGER},
		shop_name = #{shopName,jdbcType=VARCHAR},
		seller_account = #{sellerAccount,jdbcType=VARCHAR},
		seller_name = #{sellerName,jdbcType=VARCHAR},
		draw_amount = #{drawAmount,jdbcType=DOUBLE},
		pay_type = #{payType,jdbcType=INTEGER},
		pay_account = #{payAccount,jdbcType=VARCHAR},
		pay_name = #{payName,jdbcType=VARCHAR},
		`status` = #{status,jdbcType=INTEGER},
		`draw_no` = #{drawNo,jdbcType=VARCHAR}
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="batchUpdate" parameterType="java.util.Map">
		update draw_apply set status =case id

		<foreach collection="ids" index="index" item="item">
			when #{item} then #{status}
		</foreach>
		end where id in
		<foreach collection="ids" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</update>
	<update id="batchUpdateDrawApplisByDrawNo" parameterType="java.util.List">
	 update draw_apply
            <trim prefix="set" suffixOverrides=",">
             <trim prefix="trade_no =case" suffix="end,">
                 <foreach collection="list" item="i" index="index">
                          when draw_no=#{i.drawNo} then #{i.tradeNo}
                 </foreach>
              </trim>
              <trim prefix=" trade_at =case" suffix="end,">
                 <foreach collection="list" item="i" index="index">
                          when draw_no=#{i.drawNo} then #{i.tradeAt}
                 </foreach>
              </trim>
              <trim prefix=" status =case" suffix="end">
                 <foreach collection="list" item="i" index="index">
                          when draw_no=#{i.drawNo} then 3
                 </foreach>
              </trim>
            </trim>
            where
            <foreach collection="list" separator="or" item="i" index="index" >
              draw_no=#{i.drawNo,jdbcType=VARCHAR}
          	</foreach>
	</update>

	<select id="selectDrawInfoByUserId" resultMap="DrawApplyInfo" parameterType="java.util.Map">
		SELECT draw_user_id,
			SUM(CASE WHEN (`status` &gt; -1 AND `status` &lt; 3) THEN draw_amount ELSE 0 END) AS draw_total,
			SUM(CASE WHEN (`status` &gt; -1 AND `status` &lt; 3 AND DATEDIFF(create_at, NOW()) = 0) THEN draw_amount ELSE 0 END) AS draw_today
		FROM draw_apply
		WHERE draw_user_id = #{userId};
	</select>

	<select id="selectDrawApplyByPage" resultMap="BaseResultMap" parameterType="java.util.Map">
		SELECT
		<include refid="Base_Column_List" />
		FROM draw_apply
		WHERE draw_user_id = #{userId}
		<if test="status != null">
			AND status in
			<foreach collection="status" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="dayRange != null">
			AND DAY(create_at) = DAY(now())
		</if>
		<if test="weekRange != null">
			AND WEEK(create_at) = WEEK(now())
		</if>
		<if test="monthRange != null">
			AND MONTH(create_at) = MONTH(now())
		</if>
		ORDER BY create_at DESC
		LIMIT #{pageStart,jdbcType=INTEGER},#{pageSize,jdbcType=INTEGER}
	</select>
	<select id="selectDrawApplyByPageCount" resultType="int" parameterType="java.util.Map">
		select
		count(1)
		FROM draw_apply
		WHERE draw_user_id = #{userId}
		<if test="status != null">
			AND status in
			<foreach collection="status" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="dayRange != null">
			AND DAY(create_at) = DAY(now())
		</if>
		<if test="weekRange != null">
			AND WEEK(create_at) = WEEK(now())
		</if>
		<if test="monthRange != null">
			AND MONTH(create_at) = MONTH(now())
		</if>
	</select>
</mapper>
